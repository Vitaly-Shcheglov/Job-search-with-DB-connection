# Проект "Поиск вакансий с подключением БД"

## Описание
Данный проект представляет собой приложение для взаимодействия с API hh.ru для получения информации о работодателях и вакансиях.
В рамках проекта необходимо получить данные о компаниях и вакансиях с сайта hh.ru, спроектировать таблицы в БД PostgreSQL и загрузить полученные данные в созданные таблицы.

##Основные шаги проекта
- **Получить данные о работодателях и их вакансиях с сайта hh.ru.** Для этого используйте публичный API hh.ru и библиотеку requests.

- **Выбрать не менее 10 интересных компаний,** от которых будут получены данные о вакансиях по API.

- **Спроектировать таблицы в БД PostgreSQL для хранения полученных данных о работодателях и их вакансиях.** Для работы с БД используется библиотека psycopg2.

- **Реализовать код, который заполняет созданные в БД PostgreSQL** таблицы данными о работодателях и их вакансиях.

- **Создать класс DBManager** для работы с данными в БД.

## Создание классов
В проекте создано несколько классов для приложения:

###В модуле hh_api для взаимодействия с API hh.ru, для получения информации о работодателях и вакансиях:
  - Класс — `HHAPI`.

### Методы: класса `HHAPI`:
- **get_companies:** Этот метод предназначен для получения информации о работодателях по их идентификаторам. Он принимает список идентификаторов компаний и возвращает список словарей с информацией о работодателях.
- **get_vacancies:** Этот метод получает список вакансий для заданного идентификатора работодателя и возвращает список вакансий.

###В модуле db_manager для управления взаимодействием с базой данных PostgreSQL создан:
  - Класс — `DBManager`.

### Методы: класса `DBManager`:
- Контекстный менеджер с использованием декоратора **@contextlib.contextmanager**: Внутри метода создается курсор базы данных с использованием **self.connection.cursor()**. Курсор используется для выполнения SQL-запросов и получения результатов.
- **create_tables:** Этот метод создает таблицы в базе данных, используя SQL-скрипт из файла schema.sql. Он открывает файл, считывает SQL-запросы и передает их методу execute для выполнения.
- **execute:** Этот метод выполняет SQL-запрос с параметрами. Он использует контекстный менеджер self.cursor() для получения курсора, выполняет запрос и затем фиксирует изменения в базе данных с помощью self.connection.commit().
- **insert_companies:** Этот метод вставляет данные о работодателях в таблицу companies. Он принимает список словарей, содержащих информацию о компаниях, и для каждой компании вызывает метод _execute, чтобы выполнить SQL-запрос на вставку.
- **insert_vacancies:** Этот метод принимает один параметр vacancies, который представляет собой список словарей. Каждый словарь содержит данные о вакансии, включая название, минимальную и максимальную зарплату, валюту и идентификатор работодателя.
- **get_companies_and_vacancies_count:** Этот метод получает количество вакансий для каждого работодателя.
- **get_all_vacancies:** Этот метод получает все вакансии из базы данных.
- **get_avg_salary:** Этот метод получает среднюю зарплату по всем вакансиям.
- **get_vacancies_with_higher_salary:** Этот метод получает список вакансий с зарплатой выше средней.
- **get_vacancies_with_keyword:** Этот метод получает вакансии, содержащие ключевое слово в названии.

## Реализация функций
В проекте реализовано несколько функций для приложения:

##В модуле schema реализованы:
  - Функция для создания базы данных — `create_database`.
  - Функция для создания таблиц — `create_tables`.

### Как работают функции
- **Функция `create_database`** создает новую базу данных с указанным именем.
   - Она принимает три параметра:
     - ```db_name``` (имя базы данных, которую нужно создать),
     - ```user``` (имя пользователя для подключения к PostgreSQL),
     - ```password``` (пароль пользователя для подключения к PostgreSQL).
   - В функции используется psycopg2 для подключения к серверу PostgreSQL, а также для выполнения SQL-запросов на создание базы данных.

- **Функция `create_tables`** создает таблицы в указанной базе данных.
   - Она также принимает три параметра:
     - ```db_nam``` (имя базы данных, в которой нужно создать таблицы),
     - ```user``` (имя пользователя для подключения к PostgreSQL),
     - ```password``` (пароль пользователя для подключения к PostgreSQL).
   - В функции происходит подключение к базе данных и выполнение SQL-запросов на создание таблиц **companies** и **vacancies**.

## В главной функции main происходит создание базы данных, таблиц и загрузка данных о работодателях и вакансиях:

Функция `main` выполняет следующие шаги:

1. **Загрузка переменных окружения**:
   - Используется библиотека `dotenv` для загрузки переменных окружения из файла `.env`. Это позволяет хранить конфиденциальную информацию, такую как имя базы данных, пользователь и пароль, в безопасном месте.

2. **Определение параметров базы данных**:
   - Создается словарь `db_params`, который содержит параметры подключения к базе данных, включая имя базы данных, пользователя, пароль, хост и порт.

3. **Создание базы данных**:
   - Функция `create_database` вызывается с параметрами из `db_params`. Если происходит ошибка при создании базы данных, она обрабатывается и выводится сообщение об ошибке.

4. **Создание таблиц**:
   - После успешного создания базы данных вызывается функция `create_tables`, которая создает необходимые таблицы в базе данных. В случае ошибки также выводится сообщение.

5. **Инициализация API и DBManager**:
   - Создается экземпляр класса `HHAPI` для работы с API hh.ru и экземпляр класса `DBManager` для управления взаимодействием с базой данных.

6. **Загрузка данных о компаниях**:
   - Определяется список идентификаторов компаний, для которых будет загружена информация. Метод `get_companies` API вызывается с этими идентификаторами, и полученные данные о компаниях вставляются в таблицу `companies` базы данных.

7. **Загрузка вакансий**:
   - Для каждой компании из полученных данных вызывается метод `get_vacancies`, чтобы получить список вакансий, которые затем вставляются в таблицу `vacancies`. Сообщения об успешной загрузке или ошибках выводятся в консоль.

8. **Интерфейс для пользователя**:
   - После загрузки данных вызывается функция `user_interface`, предоставляющая пользователю возможность взаимодействовать с данными, включая показ количества вакансий, список всех вакансий, среднюю зарплату и вакансии по ключевому слову.

9. **Закрытие соединения**:
   - В конце работы функции закрывается соединение с базой данных.

## Тестирование
В ходе тестирования кода был выполнен ряд проверок и отладки отдельных модулей:

### Тестирование HHAPI

### Описание

Тесты для класса `HHAPI` выполняются с помощью библиотеки `unittest`. Тестовый класс `TestHHAPI` проверяет функциональность методов класса `HHAPI`, обеспечивая, что они корректно обрабатывают запросы к API hh.ru и соответствуют ожидаемым результатам.

## Структура тестов

### 1. Инициализация

- В методе `setUp` создается экземпляр класса `HHAPI`, который будет использоваться в каждом тесте.

### 2. Тестирование метода `get_companies`

#### 2.1 Успешное получение информации о работодателях
```python
@patch("requests.get")
def test_get_companies_success(self, mock_get: Mock) -> None:
```
- Этот тест проверяет успешное получение информации о работодателях по идентификатору.
- Используется `unittest.mock` для замены метода `requests.get` на мок-объект, который возвращает заранее подготовленный ответ с кодом состояния 200 и данными о компании.
- Проверяется, что возвращаемый список компаний содержит ожидаемые данные.

#### 2.2 Обработка HTTP ошибок
```python
@patch("requests.get")
def test_get_companies_http_error(self, mock_get: Mock) -> None:
```
- Этот тест проверяет обработку HTTP ошибок, например, когда запрашивается несуществующий идентификатор компании.
- Мок-объект `requests.get` настроен так, чтобы выбрасывать `HTTPError`.
- Проверяется, что метод возвращает пустой список компаний при возникновении ошибки.

### 3. Тестирование метода `get_vacancies`

#### 3.1 Успешное получение списка вакансий
```python
@patch("requests.get")
def test_get_vacancies_success(self, mock_get: Mock) -> None:
```
- Этот тест проверяет успешное получение списка вакансий для заданного работодателя.
- Мок-объект `requests.get` возвращает данные о вакансиях с кодом состояния 200.
- Проверяется, что возвращаемый список вакансий содержит ожидаемые данные.

#### 3.2 Обработка HTTP ошибок
```python
@patch("requests.get")
def test_get_vacancies_http_error(self, mock_get: Mock) -> None:
```
- Этот тест проверяет, как метод обрабатывает HTTP ошибки при запросе списка вакансий.
- Используется мок-объект, который выбрасывает `HTTPError`.
- Проверяется, что метод возвращает пустой список вакансий при возникновении ошибки.

## Запуск тестов
Тесты можно запустить, выполнив следующий код:
```python
if __name__ == "__main__":
    unittest.main()
```

##№ Тестирование DBManager

Класс `TestDBManager` предназначен для проверки функциональности методов класса `DBManager`, обеспечивая корректное взаимодействие с базой данных.

### Структура тестов

1. **Инициализация**:
   - Метод `setUp` создает экземпляр `DBManager` с мокированным соединением к базе данных, что позволяет тестировать функциональность без необходимости подключаться к реальной базе данных.

2. **Тестирование метода `insert_companies`**:
   - Проверяет корректность вставки данных о компаниях. Метод тестирует, что метод `execute` курсора вызывается нужное количество раз с правильными SQL-запросами.

3. **Тестирование метода `insert_vacancies`**:
   - Проверяет вставку данных о вакансиях. Тест также обрабатывает случай, когда информация о работодателе отсутствует, и проверяет вывод соответствующего сообщения.

4. **Тестирование метода `get_companies_and_vacancies_count`**:
   - Проверяет, что метод возвращает правильное количество вакансий для каждой компании, используя мокированный ответ курсора.

5. **Тестирование метода `get_all_vacancies`**:
   - Проверяет получение всех вакансий из базы данных и корректность возвращаемых данных.

### Запуск тестов
Тесты можно запустить, выполнив следующий код:
```python
if __name__ == "__main__":
    unittest.main()
```

### Тестирование DatabaseFunctions

Класс `TestDatabaseFunctions` предназначен для проверки функций работы с базой данных, таких как создание базы данных и таблиц.

### Структура тестов

1. **Инициализация**:
   - Метод `setUpClass` создает тестовую базу данных перед запуском тестов, используя переменные окружения для пользователя и пароля. Если переменные не заданы, выбрасывается ошибка.

2. **Тестирование создания таблиц**:
   - Метод `test_create_tables` проверяет, что таблицы `companies` и `vacancies` успешно созданы в тестовой базе данных. Он выполняет запросы к системе информации о таблицах и проверяет, существуют ли таблицы.

3. **Очистка**:
   - Метод `tearDownClass` удаляет тестовую базу данных после выполнения всех тестов, обеспечивая корректное освобождение ресурсов.

### Запуск тестов
Тесты можно запустить, выполнив следующий код:
```python
if __name__ == "__main__":
    unittest.main()
```

## Запуск тестов с помощью pytest
- Для запуска всех тестов в проекте, рекомендуется использовать библиотеку `pytest`. Это позволит вам легко и эффективно проверять функциональность вашего кода.

### Установка pytest
- Если `pytest` еще не установлен в вашем проекте, вы можете установить его с помощью следующей команды: ```pip install pytest```
- Если вы используете `Poetry`, вы можете добавить `pytest` как зависимость для разработки: ```poetry add --dev pytest```

### Запуск всех тестов
- Чтобы запустить все тесты в вашем проекте, выполните следующую команду в терминале или командной строке, находясь в корне вашего проекта: ```pytest```

## Установка проекта
1. Установите и запустите PyCharm.
Клонирование репозитория
```git clone https://github.com/Vitaly-Shcheglov/Job-search-with-DB-connection.git```

## Запуск проекта
1. Установите зависимости с помощью следующей команды: ```pip install -r requirements.txt```

2. Установите PostgreSQL и pgAdmin.
```Ссылка для Windows https://www.postgresql.org/download/windows/```
```Ссылка для macOShttps://www.postgresql.org/download/macosx/```

4. Запустите pgAdmin.

5. Активация Виртуального Окружения
Если у вас есть виртуальное окружение .venv, убедитесь, что оно активировано.
В зависимости от вашей операционной системы выполните одну из следующих команд:
```Windows: .venv\Scripts\activate```
```macOS / Linux: source .venv/bin/activate```

6. После активации окружения установите необходимые зависимости, такие как python-dotenv с помощью следующей команды: ```pip install python-dotenv```
Установите недостающие зависимости с помощью следующей команды: ```pip install -r requirements.txt```

7. В PyCharm Подключитесь к PostgreSQL из Python с помощью библиотеки psycopg2.
Перед тем как начать работу с psycopg2, необходимо установить библиотеку с помощью следующей команды:```pip install psycopg2```

8. После установки библиотеки мы можем подключиться к базе данных PostgreSQL.
Для этого необходимо создать соединение с базой данных.
В модуле .env.example введите ваши данные:
DB_NAME=```"имя_вашей_базы_данных"```
DB_USER=```"ваш_пользователь"```
DB_PASSWORD=```"ваш_пароль"```
DB_HOST=```"ваш-хост"```
DB_PORT=```"ваш порт"```

9.Запустите модуль main.py с помощью следующей команды: ```python main.py```
После сообщений о создании базы данных и таблиц будет запущена функция взаимодествия с пользователем:

## Пользовательский интерфейс

После загрузки данных программа предоставляет пользователю интерфейс для взаимодействия с базой данных. Пользователь может выбрать одно из следующих действий:

1. **Показать количество вакансий у каждой компании**: Выводит количество вакансий для каждой компании в базе данных.
2. **Показать все вакансии**: Выводит список всех вакансий, включая информацию о компании и зарплате.
3. **Показать среднюю зарплату по вакансиям**: Выводит среднюю зарплату по всем вакансиям в базе данных.
4. **Показать вакансии с зарплатой выше средней**: Выводит вакансии, которые имеют зарплату выше средней.
5. **Показать вакансии по ключевому слову**: Позволяет пользователю ввести ключевое слово и выводит вакансии, содержащие это слово в названии.
6. **Выход**: Завершает работу программы.

Программа обрабатывает неверные выборы и выводит соответствующие сообщения, если что-то пошло не так.
